<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>スレッド</title>
  <style>
    @font-face {
      font-family: 'Senobi-Gothic';
      src: url('src/font/MODI_Senobi-Gothic_2017_0702 2/Senobi-Gothic-Regular.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'Senobi-Gothic';
      src: url('src/font/MODI_Senobi-Gothic_2017_0702 2/Senobi-Gothic-Medium.ttf') format('truetype');
      font-weight: 500;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'Senobi-Gothic';
      src: url('src/font/MODI_Senobi-Gothic_2017_0702 2/Senobi-Gothic-Bold.ttf') format('truetype');
      font-weight: bold;
      font-style: normal;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* Dynamic Viewport Height for mobile */
      overflow: hidden;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #e8f5e9;
    }
    
    .main-container {
      width: 100%;
      max-width: 924px;
      position: relative;
      margin: 0 auto;
      background-color: #e8f5e9;
      overflow-x: hidden;
      overflow-y: auto;
      height: 100vh;
      height: 100dvh;
    }
    
    /* コンテンツが100vhを超える場合でもスクロールできるようにする */
    .content-wrapper {
      min-height: 100vh;
      min-height: 100dvh;
    }
    
    .stone-image-container {
      position: relative;
      width: 100%;
      max-width: 924px;
      margin: 0 auto;
      background-image: url('src/thread_page/backgound.png');
      background-repeat: repeat-y;
      background-position: top center;
      background-size: 100% auto;
    }
    
    .caption-image-loader {
      position: absolute;
      visibility: hidden;
      width: 0;
      height: 0;
    }
    
    .stone-image-loader {
      position: absolute;
      visibility: hidden;
      width: 0;
      height: 0;
    }
    
    .stone-image {
      /* 初期値は設定せず、JavaScriptで動的に設定 */
      display: block;
      position: relative;
      z-index: 1;
      box-sizing: border-box;
    }
    
    .comment-area {
      position: absolute;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 15px;
      box-sizing: border-box;
      z-index: 2;
      font-family: 'Senobi-Gothic', sans-serif;
      visibility: visible;
      opacity: 1;
    }
    
    .comment-area::-webkit-scrollbar {
      width: 4px;
    }
    
    .comment-area::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .comment-area::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 2px;
    }
    
    .post-item {
      color: #333;
      font-family: 'Senobi-Gothic', sans-serif;
      line-height: 1.6;
      word-wrap: break-word;
      margin-bottom: 20px;
    }
    
    .post-item .nickname {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .post-item .comment {
      white-space: pre-wrap;
      margin-top: 10px;
    }
    
    .post-item .timestamp {
      color: #999;
      margin-top: 10px;
      font-size: 0.7em;
    }
    
    .background-image-loader {
      position: absolute;
      visibility: hidden;
      width: 0;
      height: 0;
    }
    
    .content-wrapper {
      position: relative;
      z-index: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    #stonesContainer {
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .posts-container {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .caption-container {
      width: 100%;
      max-width: 924px;
      margin: 0 auto;
      padding: 0;
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: center;
      background-image: url('src/thread_page/backgound.png');
      background-repeat: repeat-y;
      background-position: top center;
      background-size: 100% auto;
      flex-shrink: 0;
    }
    
    .caption-container img {
      width: 100%;
      height: auto;
      display: block;
      max-width: var(--bg-width, 100%);
    }
    
    .fixed-post-button {
      position: relative;
      z-index: 1000;
      max-width: 924px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      padding: 0;
      background-color: transparent;
      flex-shrink: 0;
    }
    
    .fixed-post-button button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      pointer-events: auto;
    }
    
    .fixed-post-button img {
      width: var(--bg-width, 100%);
      max-width: var(--bg-width, 100%);
      height: auto;
      display: block;
    }
    
    .fixed-post-button button:active {
      opacity: 0.8;
    }
    
    /* スマホ向けの最適化（480px以下は100%表示） */
    @media (max-width: 480px) {
      .main-container {
        max-width: 100%;
        width: 100vw;
      }
      
      .stone-image-container {
        max-width: 100%;
      }
      
      .fixed-post-button {
        max-width: 100%;
      }
    }
    
    /* タブレット向け（481px〜924pxは924pxに制限） */
    @media (min-width: 481px) and (max-width: 924px) {
      .main-container {
        max-width: 924px;
      }
      
      .stone-image-container {
        max-width: 924px;
      }
      
      .fixed-post-button {
        max-width: 924px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <img src="src/thread_page/backgound.png" alt="" class="background-image-loader" id="bgImageLoader">
    <img src="src/thread_page/caption.png" alt="" class="caption-image-loader" id="captionImageLoader">
    <img src="src/stones/stone1.png" alt="" class="stone-image-loader" id="stoneImageLoader">
    
    <div class="content-wrapper" id="contentWrapper">
      <div id="stonesContainer">
        <!-- 各コメントごとに石がここに動的に追加されます -->
      </div>
      
      <div class="caption-container">
        <img src="src/thread_page/caption.png" alt="キャプション" id="captionImage">
      </div>
      
      <div class="fixed-post-button">
        <button onclick="goToPost()">
          <img src="src/thread_page/post2.png" alt="投稿" id="postButtonImage">
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://isi2-backend.onrender.com';
    
    // URLパラメータから石IDを取得
    function getStoneIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const stoneId = urlParams.get('stoneId');
      
      // URLパラメータがない場合は、ホスト名から取得を試みる
      if (!stoneId) {
        const host = window.location.hostname;
        // isi2.onrender.com → stone-002
        const match = host.match(/^isi(\d+)/);
        if (match) {
          const num = match[1].padStart(3, '0');
          return `stone-${num}`;
        }
      }
      
      return stoneId;
    }
    
    const stoneId = getStoneIdFromUrl();
    
    // コメント欄の座標（元画像サイズに対する相対座標）
    const COMMENT_AREA = {
      x: 175,
      y: 139,
      width: 546,
      height: 279
    };
    
    // ステップ1: 必要なbackgound.pngの数を計算
    function calculateRequiredBackgroundCount() {
      const bgImageLoader = document.getElementById('bgImageLoader');
      const captionImageLoader = document.getElementById('captionImageLoader');
      const stoneImageLoader = document.getElementById('stoneImageLoader');
      const captionImage = document.getElementById('captionImage');
      const stonesContainer = document.getElementById('stonesContainer');
      const mainContainer = document.querySelector('.main-container');
      
      if (!bgImageLoader || !captionImageLoader || !stoneImageLoader || 
          !captionImage || !stonesContainer || !mainContainer) {
        return null;
      }
      
      // すべての画像が読み込まれるまで待つ
      if (!bgImageLoader.complete || !captionImageLoader.complete || 
          !stoneImageLoader.complete || !captionImage.complete) {
        return null;
      }
      
      const containerWidth = mainContainer.offsetWidth || Math.min(window.innerWidth, 924);
      
      // バックグラウンドの元の幅と高さ
      const bgWidth = bgImageLoader.naturalWidth;
      const bgHeight = bgImageLoader.naturalHeight;
      
      // バックグラウンドのスケール後の幅を計算（これが基準になる）
      // バックグラウンドの幅を損なわないように、元の幅を優先
      const bgScaledWidth = Math.min(bgWidth, containerWidth, 924);
      const bgScale = bgScaledWidth / bgWidth;
      
      // すべての画像はバックグラウンドのスケール後の幅に合わせる
      const maxWidth = bgScaledWidth;
      
      const stoneWidth = stoneImageLoader.naturalWidth;
      const stoneHeight = stoneImageLoader.naturalHeight;
      const stoneScale = maxWidth / stoneWidth;
      
      const captionWidth = captionImageLoader.naturalWidth;
      const captionHeight = captionImageLoader.naturalHeight;
      const captionScale = maxWidth / captionWidth;
      
      // スケール後の高さを計算
      const scaledStoneHeight = stoneHeight * stoneScale;
      const scaledCaptionHeight = captionHeight * captionScale;
      const scaledBgHeight = bgHeight * bgScale;
      
      // 投稿数を取得
      const stoneContainers = stonesContainer.querySelectorAll('.stone-image-container');
      const postCount = stoneContainers.length;
      
      // 必要な高さ = 投稿の石の縦のピクセル数 × 投稿数 + caption.pngの縦のピクセル数
      const totalHeight = (scaledStoneHeight * postCount) + scaledCaptionHeight;
      
      // 必要な背景画像の個数を計算（切り上げ）
      const bgCount = Math.ceil(totalHeight / scaledBgHeight);
      
      console.log('背景計算:', {
        postCount,
        scaledStoneHeight,
        scaledCaptionHeight,
        totalHeight,
        scaledBgHeight,
        bgCount
      });
      
      return {
        bgCount,
        scaledBgHeight,
        scaledStoneHeight,
        scaledCaptionHeight,
        maxWidth,
        bgScale,
        stoneScale,
        captionScale
      };
    }
    
    // ステップ2: caption.pngとpost2.pngを画面最下部に下合わせで表示
    function positionBottomElements(calcData) {
      if (!calcData) return;
      
      const captionContainer = document.querySelector('.caption-container');
      const postButton = document.querySelector('.fixed-post-button');
      const captionImage = document.getElementById('captionImage');
      const postButtonImage = document.getElementById('postButtonImage');
      const contentWrapper = document.getElementById('contentWrapper');
      
      if (captionContainer && captionImage) {
        // captionの幅を設定
        captionImage.style.width = `${calcData.maxWidth}px`;
        captionImage.style.maxWidth = `${calcData.maxWidth}px`;
        
        // captionコンテナの高さを設定（背景が必要な高さ）
        const captionBgCount = Math.ceil(calcData.scaledCaptionHeight / calcData.scaledBgHeight);
        captionContainer.style.minHeight = `${captionBgCount * calcData.scaledBgHeight}px`;
      }
      
      if (postButton && postButtonImage) {
        // post2の幅を設定
        postButtonImage.style.width = `${calcData.maxWidth}px`;
        postButtonImage.style.maxWidth = `${calcData.maxWidth}px`;
      }
      
      // コンテンツラッパーの高さを設定（必要な背景枚数分）
      if (contentWrapper && calcData.bgCount) {
        contentWrapper.style.minHeight = `${calcData.bgCount * calcData.scaledBgHeight}px`;
      }
    }
    
    // ステップ3: コメント欄を積み上げていく
    function setupStones(calcData) {
      if (!calcData) return;
      
      const stonesContainer = document.getElementById('stonesContainer');
      if (!stonesContainer) return;
      
      const stoneContainers = stonesContainer.querySelectorAll('.stone-image-container');
      
      stoneContainers.forEach(stoneContainer => {
        const stoneImg = stoneContainer.querySelector('.stone-image');
        if (stoneImg && stoneImg.complete) {
          // 各石コンテナに必要な背景画像の個数を計算
          const bgCount = Math.ceil(calcData.scaledStoneHeight / calcData.scaledBgHeight);
          stoneContainer.style.minHeight = `${bgCount * calcData.scaledBgHeight}px`;
        }
      });
    }
    
    // 背景画像の必要な高さを計算して設定（統合関数）
    function calculateBackgroundHeight() {
      const calcData = calculateRequiredBackgroundCount();
      if (calcData) {
        positionBottomElements(calcData);
        setupStones(calcData);
      }
    }
    
    // 石画像のサイズを調整（個別の石コンテナに対して）
    function adjustStoneSize(stoneContainer, stoneImage) {
      const mainContainer = document.querySelector('.main-container');
      
      if (!stoneImage || !stoneContainer || !mainContainer) {
        return;
      }
      
      // 画像のサイズを確認（確実に読み込まれるまで待つ）
      if (stoneImage.naturalWidth === 0 || stoneImage.naturalHeight === 0) {
        // 画像がまだ読み込まれていない場合は再試行
        setTimeout(() => adjustStoneSize(stoneContainer, stoneImage), 100);
        return;
      }
      
      // バックグラウンドの幅を基準にする
      const bgImageLoader = document.getElementById('bgImageLoader');
      if (!bgImageLoader || !bgImageLoader.complete) {
        setTimeout(() => adjustStoneSize(stoneContainer, stoneImage), 100);
        return;
      }
      
      // コンテナの幅を取得
      let containerWidth = mainContainer.offsetWidth || mainContainer.clientWidth;
      if (!containerWidth || containerWidth === 0) {
        containerWidth = Math.min(window.innerWidth || 924, 924);
      }
      
      // バックグラウンドの元の幅と高さ
      const bgNaturalWidth = bgImageLoader.naturalWidth;
      const bgNaturalHeight = bgImageLoader.naturalHeight;
      
      // バックグラウンドのスケール後の幅を計算（これが基準になる）
      const bgScaledWidth = Math.min(bgNaturalWidth, containerWidth, 924);
      const bgScale = bgScaledWidth / bgNaturalWidth;
      
      const naturalWidth = stoneImage.naturalWidth;
      const naturalHeight = stoneImage.naturalHeight;
      
      // バックグラウンドのスケール後の幅に合わせて石のサイズを決定
      // 石の元の幅とバックグラウンドのスケール後の幅の小さい方を使用
      const maxWidth = Math.min(naturalWidth, bgScaledWidth);
      
      // スケール比を計算
      const scale = maxWidth / naturalWidth;
      
      // 石画像のサイズを設定（画像の元のアスペクト比を維持）
      stoneImage.style.width = `${maxWidth}px`;
      stoneImage.style.height = 'auto';
      stoneImage.style.maxWidth = `${maxWidth}px`;
      stoneImage.style.minWidth = `${maxWidth}px`;
      stoneImage.style.display = 'block';
      stoneImage.style.flexShrink = '0';
      stoneImage.style.flexGrow = '0';
      stoneImage.style.objectFit = 'contain';
      stoneImage.style.boxSizing = 'border-box';
      
      // 石コンテナの幅も設定（画像の幅に合わせる）
      stoneContainer.style.width = `${maxWidth}px`;
      stoneContainer.style.maxWidth = `${maxWidth}px`;
      stoneContainer.style.minWidth = `${maxWidth}px`;
      stoneContainer.style.margin = '0 auto';
      stoneContainer.style.display = 'block';
      stoneContainer.style.position = 'relative';
      
      // 石コンテナの高さを設定
      const stoneHeight = naturalHeight * scale;
      stoneContainer.style.minHeight = `${stoneHeight}px`;
      
      // 背景の高さを再計算（一度だけ実行するように）
      // 複数回呼ばれないようにフラグで制御
      if (!stoneContainer.dataset.adjusted) {
        stoneContainer.dataset.adjusted = 'true';
        setTimeout(() => {
          calculateBackgroundHeight();
        }, 50);
      }
    }
    
    // 背景画像のサイズに合わせてcaptionとpost2のサイズを調整
    function adjustImageSizes() {
      const bgImage = document.getElementById('bgImageLoader');
      const captionImage = document.getElementById('captionImage');
      const postButtonImage = document.getElementById('postButtonImage');
      const mainContainer = document.querySelector('.main-container');
      
      if (bgImage && captionImage && postButtonImage && mainContainer) {
        bgImage.onload = function() {
          const bgWidth = bgImage.naturalWidth;
          const containerWidth = mainContainer.offsetWidth;
          const maxWidth = Math.min(bgWidth, containerWidth, 924);
          
          // CSS変数として設定
          document.documentElement.style.setProperty('--bg-width', `${maxWidth}px`);
          
          // captionとpost2の幅を設定
          captionImage.style.width = `${maxWidth}px`;
          captionImage.style.maxWidth = `${maxWidth}px`;
          postButtonImage.style.width = `${maxWidth}px`;
          postButtonImage.style.maxWidth = `${maxWidth}px`;
          
          // 背景の高さを計算
          calculateBackgroundHeight();
        };
        
        // 既に読み込まれている場合
        if (bgImage.complete) {
          bgImage.onload();
        }
      }
    }
    
    // 投稿データを取得して表示
    async function loadPosts() {
      if (!stoneId) {
        console.error('石IDが取得できませんでした');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/posts?stoneId=${stoneId}`);
        if (!response.ok) {
          console.error('投稿データの取得に失敗しました');
          return;
        }
        
        const posts = await response.json();
        
        // 時系列順（古い順）にソート（上から下に表示）
        posts.sort((a, b) => {
          const dateA = new Date(a.createdAt);
          const dateB = new Date(b.createdAt);
          return dateA - dateB;
        });
        
        const stonesContainer = document.getElementById('stonesContainer');
        if (!stonesContainer) {
          console.error('石コンテナが見つかりません');
          return;
        }
        
        // コメントの石は表示しない
        // 各投稿ごとに石を作成する処理をコメントアウト
        // posts.forEach((post, index) => {
        //   // 石コンテナを作成
        //   const stoneContainer = document.createElement('div');
        //   stoneContainer.className = 'stone-image-container';
        //   
        //   // 石画像を作成
        //   const stoneImage = document.createElement('img');
        //   stoneImage.src = 'src/stones/stone1.png';
        //   stoneImage.alt = '石';
        //   stoneImage.className = 'stone-image';
        //   
        //   // 要素を組み立て（コメント欄は表示しない）
        //   stoneContainer.appendChild(stoneImage);
        //   stonesContainer.appendChild(stoneContainer);
        //   
        //   // 石画像のサイズを調整（画像読み込み後に実行）
        //   stoneImage.onload = () => {
        //     adjustStoneSize(stoneContainer, stoneImage);
        //   };
        //   
        //   // 既に読み込まれている場合
        //   if (stoneImage.complete) {
        //     adjustStoneSize(stoneContainer, stoneImage);
        //   }
        // });
        
        // 背景の高さを再計算
        setTimeout(() => {
          calculateBackgroundHeight();
          // 画面ロード時の初期位置を一番下に
          scrollToBottom();
        }, 500);
      } catch (error) {
        console.error('投稿データの読み込みエラー:', error);
      }
    }
    
    // HTMLエスケープ関数
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 最下部にスクロール
    function scrollToBottom() {
      const mainContainer = document.querySelector('.main-container');
      if (mainContainer) {
        // 少し遅延を入れて確実にスクロール
        setTimeout(() => {
          mainContainer.scrollTop = mainContainer.scrollHeight;
        }, 100);
      }
    }
    
    // 投稿ページへ遷移
    function goToPost() {
      const url = stoneId ? `post.html?stoneId=${stoneId}` : 'post.html';
      window.location.href = url;
    }
    
    // ページ読み込み時に投稿を読み込む
    loadPosts();
    
    // 画像サイズの調整
    adjustImageSizes();
    calculateBackgroundHeight();
    
    // ページ読み込み後に最下部にスクロール（念のため）
    window.addEventListener('load', () => {
      setTimeout(() => {
        adjustImageSizes();
        calculateBackgroundHeight();
        scrollToBottom();
      }, 500);
    });
    
    // スマホでの全面表示のための高さ設定
    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const body = document.body;
      if (body) {
        body.style.height = `${window.innerHeight}px`;
      }
      // mainContainerの高さは固定しない（コンテンツに応じて伸びるように）
    }
    
    // 初期設定とリサイズ時の処理
    setViewportHeight();
    
    // リサイズ時の処理をデバウンス
    let resizeTimer;
    window.addEventListener('resize', () => {
      setViewportHeight();
      // デバウンス処理（300ms後に実行）
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        adjustImageSizes();
        // すべての石コンテナを再調整
        const stonesContainer = document.getElementById('stonesContainer');
        if (stonesContainer) {
          const stoneContainers = stonesContainer.querySelectorAll('.stone-image-container');
          stoneContainers.forEach(container => {
            const stoneImage = container.querySelector('.stone-image');
            if (stoneImage) {
              adjustStoneSize(container, stoneImage);
            }
          });
        }
        calculateBackgroundHeight();
      }, 300);
    });
    window.addEventListener('orientationchange', () => {
      setViewportHeight();
      setTimeout(() => {
        scrollToBottom();
        adjustImageSizes();
        // すべての石コンテナを再調整
        const stonesContainer = document.getElementById('stonesContainer');
        if (stonesContainer) {
          const stoneContainers = stonesContainer.querySelectorAll('.stone-image-container');
          stoneContainers.forEach(container => {
            const stoneImage = container.querySelector('.stone-image');
            if (stoneImage) {
              adjustStoneSize(container, stoneImage);
            }
          });
        }
        calculateBackgroundHeight();
      }, 300);
    });
  </script>
</body>
</html>
