<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>スレッド</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* Dynamic Viewport Height for mobile */
      overflow: hidden;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #e8f5e9;
    }
    
    .main-container {
      width: 100%;
      height: 100%;
      max-width: 924px;
      position: relative;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      background-color: #e8f5e9;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .stone-image-container {
      position: relative;
      width: 100%;
      max-width: 924px;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background-image: url('src/thread_page/backgound.png');
      background-repeat: repeat-y;
      background-position: top center;
      background-size: 100% auto;
    }
    
    .caption-image-loader {
      position: absolute;
      visibility: hidden;
      width: 0;
      height: 0;
    }
    
    .stone-image-loader {
      position: absolute;
      visibility: hidden;
      width: 0;
      height: 0;
    }
    
    .stone-image {
      width: 100%;
      height: auto;
      max-width: 924px;
      display: block;
      position: relative;
      z-index: 1;
    }
    
    .comment-area {
      position: absolute;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px;
      box-sizing: border-box;
      z-index: 2;
    }
    
    .comment-area::-webkit-scrollbar {
      width: 4px;
    }
    
    .comment-area::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .comment-area::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 2px;
    }
    
    .post-item {
      color: #333;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .post-item .nickname {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .post-item .comment {
      white-space: pre-wrap;
      margin-top: 5px;
    }
    
    .post-item .timestamp {
      color: #999;
      font-size: 11px;
      margin-top: 5px;
    }
    
    .background-image-loader {
      position: absolute;
      visibility: hidden;
      width: 0;
      height: 0;
    }
    
    .content-wrapper {
      position: relative;
      z-index: 1;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      padding-bottom: 120px; /* ボタンとcaptionのスペース */
    }
    
    .posts-container {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .caption-container {
      width: 100%;
      max-width: 924px;
      margin: 0 auto;
      padding: 20px 20px 0 20px;
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: center;
    }
    
    .caption-container img {
      width: 100%;
      height: auto;
      display: block;
      max-width: var(--bg-width, 100%);
    }
    
    .fixed-post-button {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      max-width: 924px;
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0;
      background-color: transparent;
      pointer-events: none;
    }
    
    .fixed-post-button button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      pointer-events: auto;
    }
    
    .fixed-post-button img {
      width: var(--bg-width, 100%);
      max-width: var(--bg-width, 100%);
      height: auto;
      display: block;
    }
    
    .fixed-post-button button:active {
      opacity: 0.8;
    }
    
    /* スマホ向けの最適化（480px以下は100%表示） */
    @media (max-width: 480px) {
      .main-container {
        max-width: 100%;
        width: 100vw;
      }
      
      .stone-image-container {
        max-width: 100%;
      }
      
      .fixed-post-button {
        max-width: 100%;
      }
    }
    
    /* タブレット向け（481px〜924pxは924pxに制限） */
    @media (min-width: 481px) and (max-width: 924px) {
      .main-container {
        max-width: 924px;
      }
      
      .stone-image-container {
        max-width: 924px;
      }
      
      .fixed-post-button {
        max-width: 924px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <img src="src/thread_page/backgound.png" alt="" class="background-image-loader" id="bgImageLoader">
    <img src="src/thread_page/caption.png" alt="" class="caption-image-loader" id="captionImageLoader">
    <img src="src/stones/stone1.png" alt="" class="stone-image-loader" id="stoneImageLoader">
    
    <div class="content-wrapper" id="contentWrapper">
      <div class="stone-image-container">
        <img src="src/stones/stone1.png" alt="石" class="stone-image" id="stoneImage">
        <div class="comment-area" id="commentArea">
          <!-- 投稿がここに表示されます -->
        </div>
      </div>
      
      <div class="caption-container">
        <img src="src/thread_page/caption.png" alt="キャプション" id="captionImage">
      </div>
    </div>
    
    <div class="fixed-post-button">
      <button onclick="goToPost()">
        <img src="src/thread_page/post2.png" alt="投稿" id="postButtonImage">
      </button>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://isi2-backend.onrender.com';
    
    // URLパラメータから石IDを取得
    function getStoneIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const stoneId = urlParams.get('stoneId');
      
      // URLパラメータがない場合は、ホスト名から取得を試みる
      if (!stoneId) {
        const host = window.location.hostname;
        // isi2.onrender.com → stone-002
        const match = host.match(/^isi(\d+)/);
        if (match) {
          const num = match[1].padStart(3, '0');
          return `stone-${num}`;
        }
      }
      
      return stoneId;
    }
    
    const stoneId = getStoneIdFromUrl();
    
    // コメント欄の座標（元画像サイズに対する相対座標）
    const COMMENT_AREA = {
      x: 175,
      y: 139,
      width: 546,
      height: 279
    };
    
    // 背景画像の必要な高さを計算して設定
    function calculateBackgroundHeight() {
      const bgImageLoader = document.getElementById('bgImageLoader');
      const captionImageLoader = document.getElementById('captionImageLoader');
      const stoneImageLoader = document.getElementById('stoneImageLoader');
      const stoneImage = document.getElementById('stoneImage');
      const captionImage = document.getElementById('captionImage');
      const stoneContainer = document.querySelector('.stone-image-container');
      const mainContainer = document.querySelector('.main-container');
      
      if (!bgImageLoader || !captionImageLoader || !stoneImageLoader || 
          !stoneImage || !captionImage || !stoneContainer || !mainContainer) {
        return;
      }
      
      // すべての画像が読み込まれるまで待つ
      const checkAllLoaded = () => {
        if (bgImageLoader.complete && captionImageLoader.complete && 
            stoneImageLoader.complete && stoneImage.complete && captionImage.complete) {
          const containerWidth = mainContainer.offsetWidth;
          const maxWidth = Math.min(924, containerWidth);
          
          // 各画像のスケール比を計算
          const bgWidth = bgImageLoader.naturalWidth;
          const bgHeight = bgImageLoader.naturalHeight;
          const bgScale = maxWidth / bgWidth;
          
          const stoneWidth = stoneImageLoader.naturalWidth;
          const stoneHeight = stoneImageLoader.naturalHeight;
          const stoneScale = maxWidth / stoneWidth;
          
          const captionWidth = captionImageLoader.naturalWidth;
          const captionHeight = captionImageLoader.naturalHeight;
          const captionScale = maxWidth / captionWidth;
          
          // スケール後の高さを計算
          const scaledStoneHeight = stoneHeight * stoneScale;
          const scaledCaptionHeight = captionHeight * captionScale;
          const scaledBgHeight = bgHeight * bgScale;
          
          // 必要な高さ = 石の高さ + キャプションの高さ
          const totalHeight = scaledStoneHeight + scaledCaptionHeight;
          
          // 必要な背景画像の個数を計算（切り上げ）
          const bgCount = Math.ceil(totalHeight / scaledBgHeight);
          
          // 石コンテナの高さを設定（背景が十分に表示されるように）
          stoneContainer.style.minHeight = `${bgCount * scaledBgHeight}px`;
        }
      };
      
      // 画像読み込みイベントを設定
      bgImageLoader.onload = checkAllLoaded;
      captionImageLoader.onload = checkAllLoaded;
      stoneImageLoader.onload = checkAllLoaded;
      stoneImage.onload = checkAllLoaded;
      captionImage.onload = checkAllLoaded;
      
      // 既に読み込まれている場合
      checkAllLoaded();
    }
    
    // 石画像とコメント欄の位置を調整
    function adjustStoneAndCommentArea() {
      const stoneImage = document.getElementById('stoneImage');
      const commentArea = document.getElementById('commentArea');
      const stoneContainer = document.querySelector('.stone-image-container');
      const mainContainer = document.querySelector('.main-container');
      
      if (stoneImage && commentArea && stoneContainer && mainContainer) {
        stoneImage.onload = function() {
          const naturalWidth = stoneImage.naturalWidth;
          const naturalHeight = stoneImage.naturalHeight;
          const containerWidth = mainContainer.offsetWidth;
          const maxWidth = Math.min(naturalWidth, containerWidth, 924);
          
          // スケール比を計算
          const scale = maxWidth / naturalWidth;
          
          // 石画像のサイズを設定
          stoneImage.style.width = `${maxWidth}px`;
          stoneImage.style.height = 'auto';
          
          // コメント欄の位置とサイズを設定
          commentArea.style.left = `${COMMENT_AREA.x * scale}px`;
          commentArea.style.top = `${COMMENT_AREA.y * scale}px`;
          commentArea.style.width = `${COMMENT_AREA.width * scale}px`;
          commentArea.style.height = `${COMMENT_AREA.height * scale}px`;
          
          // フォントサイズもスケール
          const baseFontSize = 14;
          commentArea.style.fontSize = `${baseFontSize * scale}px`;
          
          // 背景の高さを再計算
          calculateBackgroundHeight();
        };
        
        // 既に読み込まれている場合
        if (stoneImage.complete) {
          stoneImage.onload();
        }
      }
    }
    
    // 背景画像のサイズに合わせてcaptionとpost2のサイズを調整
    function adjustImageSizes() {
      const bgImage = document.getElementById('bgImageLoader');
      const captionImage = document.getElementById('captionImage');
      const postButtonImage = document.getElementById('postButtonImage');
      const mainContainer = document.querySelector('.main-container');
      
      if (bgImage && captionImage && postButtonImage && mainContainer) {
        bgImage.onload = function() {
          const bgWidth = bgImage.naturalWidth;
          const containerWidth = mainContainer.offsetWidth;
          const maxWidth = Math.min(bgWidth, containerWidth, 924);
          
          // CSS変数として設定
          document.documentElement.style.setProperty('--bg-width', `${maxWidth}px`);
          
          // captionとpost2の幅を設定
          captionImage.style.width = `${maxWidth}px`;
          captionImage.style.maxWidth = `${maxWidth}px`;
          postButtonImage.style.width = `${maxWidth}px`;
          postButtonImage.style.maxWidth = `${maxWidth}px`;
          
          // 背景の高さを計算
          calculateBackgroundHeight();
        };
        
        // 既に読み込まれている場合
        if (bgImage.complete) {
          bgImage.onload();
        }
      }
    }
    
    // 投稿データを取得して表示
    async function loadPosts() {
      if (!stoneId) {
        console.error('石IDが取得できませんでした');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/posts?stoneId=${stoneId}`);
        if (!response.ok) {
          console.error('投稿データの取得に失敗しました');
          return;
        }
        
        const posts = await response.json();
        const commentArea = document.getElementById('commentArea');
        
        if (!commentArea) {
          console.error('コメント欄が見つかりません');
          return;
        }
        
        // 時系列順（新しい順）にソート
        posts.sort((a, b) => {
          const dateA = new Date(a.createdAt);
          const dateB = new Date(b.createdAt);
          return dateB - dateA;
        });
        
        // 最新の投稿のみを表示（一つの石に対して一つのコメント）
        if (posts.length > 0) {
          const post = posts[0];
          const postElement = document.createElement('div');
          postElement.className = 'post-item';
          
          let html = '';
          if (post.nickname) {
            html += `<div class="nickname" style="color: ${post.pinColor || '#333'};">${post.nickname}</div>`;
          }
          if (post.comment) {
            html += `<div class="comment">${escapeHtml(post.comment)}</div>`;
          }
          if (post.createdAt) {
            html += `<div class="timestamp">${new Date(post.createdAt).toLocaleString('ja-JP')}</div>`;
          }
          
          postElement.innerHTML = html;
          commentArea.appendChild(postElement);
          
          // コメント欄を最下部にスクロール
          setTimeout(() => {
            commentArea.scrollTop = commentArea.scrollHeight;
          }, 100);
        }
      } catch (error) {
        console.error('投稿データの読み込みエラー:', error);
      }
    }
    
    // HTMLエスケープ関数
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 最下部にスクロール
    function scrollToBottom() {
      const commentArea = document.getElementById('commentArea');
      if (commentArea) {
        commentArea.scrollTop = commentArea.scrollHeight;
      }
    }
    
    // 投稿ページへ遷移
    function goToPost() {
      const url = stoneId ? `post.html?stoneId=${stoneId}` : 'post.html';
      window.location.href = url;
    }
    
    // ページ読み込み時に投稿を読み込む
    loadPosts();
    
    // 画像サイズの調整
    adjustImageSizes();
    adjustStoneAndCommentArea();
    calculateBackgroundHeight();
    
    // ページ読み込み後に最下部にスクロール（念のため）
    window.addEventListener('load', () => {
      setTimeout(scrollToBottom, 200);
      adjustImageSizes();
      adjustStoneAndCommentArea();
      calculateBackgroundHeight();
    });
    
    // スマホでの全面表示のための高さ設定
    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const body = document.body;
      const mainContainer = document.querySelector('.main-container');
      if (body && mainContainer) {
        body.style.height = `${window.innerHeight}px`;
        mainContainer.style.height = `${window.innerHeight}px`;
      }
    }
    
    // 初期設定とリサイズ時の処理
    setViewportHeight();
    window.addEventListener('resize', () => {
      setViewportHeight();
      adjustImageSizes();
      adjustStoneAndCommentArea();
      calculateBackgroundHeight();
    });
    window.addEventListener('orientationchange', () => {
      setViewportHeight();
      setTimeout(() => {
        scrollToBottom();
        adjustImageSizes();
        adjustStoneAndCommentArea();
        calculateBackgroundHeight();
      }, 300);
    });
  </script>
</body>
</html>
