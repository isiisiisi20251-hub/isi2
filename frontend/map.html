<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>マップ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* Dynamic Viewport Height for mobile */
      overflow: hidden;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f5f5f5;
    }
    
    .main-container {
      width: 100%;
      height: 100%;
      max-width: 924px;
      position: relative;
      margin: 0 auto;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    .next-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      cursor: pointer;
      transition: transform 0.2s;
      max-width: 200px;
      height: auto;
    }
    
    .next-button:hover {
      transform: translateX(-50%) scale(1.05);
    }
    
    .next-button:active {
      transform: translateX(-50%) scale(0.95);
    }
    
    @media (max-width: 480px) {
      .main-container {
        max-width: 100%;
        width: 100vw;
      }
      
      .next-button {
        bottom: 10px;
        max-width: 150px;
      }
    }
    
    @media (min-width: 481px) and (max-width: 924px) {
      .main-container {
        max-width: 924px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div id="map"></div>
    <img src="/src/map_page/next_button1.png" alt="次へ" class="next-button" id="nextButton">
  </div>

  <script>
    let map;
    let markers = []; // マーカーを保存する配列
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://isi2-backend.onrender.com';
    
    // ピンの色の配列
    const pinColors = ['#F17900', '#6466FF', '#00C27E', '#F2DD4E'];
    
    // スマホでの全面表示のための高さ設定
    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const body = document.body;
      const mainContainer = document.querySelector('.main-container');
      if (body && mainContainer) {
        body.style.height = `${window.innerHeight}px`;
        mainContainer.style.height = `${window.innerHeight}px`;
      }
    }
    
    // 初期設定とリサイズ時の処理
    setViewportHeight();
    window.addEventListener('resize', setViewportHeight);
    window.addEventListener('orientationchange', setViewportHeight);
    
    // URLパラメータから石IDを取得
    function getStoneIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const stoneId = urlParams.get('stoneId');
      
      // URLパラメータがない場合は、ホスト名から取得を試みる
      if (!stoneId) {
        const host = window.location.hostname;
        // isi2.onrender.com → stone-002
        const match = host.match(/^isi(\d+)/);
        if (match) {
          const num = match[1].padStart(3, '0');
          return `stone-${num}`;
        }
      }
      
      return stoneId;
    }
    
    const stoneId = getStoneIdFromUrl();

    // ズームレベルに応じたピンのサイズを計算
    function getPinScale(zoom) {
      // ズームレベルに応じてサイズを調整（ズームが大きいほどピンも大きくなる）
      // ズームレベル10-20の範囲で、scale 12-36の範囲にマッピング（2/3倍）
      const minZoom = 10;
      const maxZoom = 20;
      const minScale = 12;
      const maxScale = 36;
      
      if (zoom <= minZoom) return minScale;
      if (zoom >= maxZoom) return maxScale;
      
      // 線形補間
      const ratio = (zoom - minZoom) / (maxZoom - minZoom);
      return minScale + (maxScale - minScale) * ratio;
    }

    // カスタムマーカーアイコンを作成
    function createCustomMarkerIcon(color, zoom) {
      const scale = getPinScale(zoom || 15);
      return {
        path: google.maps.SymbolPath.CIRCLE,
        scale: scale,
        fillColor: color,
        fillOpacity: 1,
        strokeColor: '#ffffff',
        strokeWeight: Math.max(3, Math.floor(scale / 6))
      };
    }
    
    // ズーム変更時にマーカーのサイズを更新
    function updateMarkerSizes() {
      if (!map) return;
      const zoom = map.getZoom();
      markers.forEach((markerData, index) => {
        if (markerData.marker) {
          const newIcon = createCustomMarkerIcon(markerData.color, zoom);
          markerData.marker.setIcon(newIcon);
        }
      });
    }

    // 投稿データを取得してマーカーを表示
    async function loadPostsAndDisplayMarkers() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/posts?stoneId=${stoneId}`);
        if (!response.ok) {
          console.error('投稿データの取得に失敗しました');
          return;
        }
        
        const posts = await response.json();
        
        // 時系列順（古い順）にソート
        posts.sort((a, b) => {
          const dateA = new Date(a.createdAt);
          const dateB = new Date(b.createdAt);
          return dateA - dateB;
        });
        
        // 位置情報がある投稿のみフィルタリングし、数値に変換
        const postsWithLocation = posts
          .map(post => {
            const lat = parseFloat(post.postLocationLat);
            const lng = parseFloat(post.postLocationLng);
            if (isNaN(lat) || isNaN(lng)) {
              return null;
            }
            return {
              ...post,
              postLocationLat: lat,
              postLocationLng: lng
            };
          })
          .filter(post => post !== null);
        
        if (postsWithLocation.length === 0) {
          console.log('位置情報のある投稿がありません');
          return;
        }
        
        // マップの中心を最初の投稿の位置に設定
        const firstPost = postsWithLocation[0];
        map.setCenter({
          lat: firstPost.postLocationLat,
          lng: firstPost.postLocationLng
        });
        
        // すべての投稿位置を含む範囲を計算
        const bounds = new google.maps.LatLngBounds();
        postsWithLocation.forEach(post => {
          bounds.extend({
            lat: post.postLocationLat,
            lng: post.postLocationLng
          });
        });
        
        // マップをすべてのマーカーが表示されるように調整
        if (postsWithLocation.length > 1) {
          map.fitBounds(bounds);
        } else {
          map.setZoom(15);
        }
        
        // 時系列順にピンを表示（アニメーション）と線で繋ぐ
        postsWithLocation.forEach((post, index) => {
          // 保存された色を使用、なければデフォルト色
          let color = post.pinColor || pinColors[index % pinColors.length];
          
          setTimeout(() => {
            const position = {
              lat: post.postLocationLat,
              lng: post.postLocationLng
            };
            
            const marker = new google.maps.Marker({
              position: position,
              map: map,
              icon: createCustomMarkerIcon(color, map.getZoom()),
              title: post.nickname || '投稿',
              optimized: false
            });
            
            // マーカーを配列に保存
            markers.push({
              marker: marker,
              color: color,
              position: position
            });
            
            // 前のピンから現在のピンへ線を引く（最初のピン以外）
            if (index > 0) {
              const previousPost = postsWithLocation[index - 1];
              const previousColor = previousPost.pinColor || pinColors[(index - 1) % pinColors.length];
              
              const polyline = new google.maps.Polyline({
                path: [
                  { lat: previousPost.postLocationLat, lng: previousPost.postLocationLng },
                  position
                ],
                strokeColor: previousColor,
                strokeOpacity: 0.8,
                strokeWeight: 3,
                map: map
              });
            }
          }, index * 300); // 300ms間隔で表示
        });
        
        // ズーム変更イベントリスナーを追加
        map.addListener('zoom_changed', updateMarkerSizes);
        
      } catch (error) {
        console.error('投稿データの取得エラー:', error);
      }
    }

    // Google Maps APIキーを取得して地図を初期化
    async function initMap() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/google-maps-config`);
        const config = await response.json();
        
        if (!config.apiKey) {
          console.error('Google Maps APIキーが設定されていません');
          return;
        }

        // Google Maps JavaScript APIを動的に読み込む
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${config.apiKey}&callback=loadMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
        
        window.loadMap = function() {
          // デフォルトの位置（東京芸術大学上野キャンパス付近）
          const defaultLocation = { lat: 35.7175, lng: 139.7733 };
          
          const mapOptions = {
            center: defaultLocation,
            zoom: 15,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            zoomControl: true,
            styles: [
              {
                featureType: 'all',
                elementType: 'geometry',
                stylers: [
                  { saturation: -100 },
                  { lightness: 50 }
                ]
              },
              {
                featureType: 'all',
                elementType: 'labels.text.fill',
                stylers: [
                  { saturation: -100 },
                  { lightness: 40 }
                ]
              },
              {
                featureType: 'all',
                elementType: 'labels.text.stroke',
                stylers: [
                  { saturation: -100 },
                  { lightness: 100 },
                  { weight: 2 }
                ]
              },
              {
                featureType: 'water',
                elementType: 'geometry',
                stylers: [
                  { saturation: -100 },
                  { lightness: 50 }
                ]
              }
            ]
          };
          
          // mapIdがある場合は使用しない（スタイルを優先）
          // if (config.mapId) {
          //   mapOptions.mapId = config.mapId;
          // }
          
          map = new google.maps.Map(document.getElementById('map'), mapOptions);
          
          // 投稿データを読み込んでマーカーを表示
          loadPostsAndDisplayMarkers();
        };
      } catch (error) {
        console.error('地図の初期化エラー:', error);
      }
    }

    // 次へボタンのクリックイベント
    document.getElementById('nextButton').addEventListener('click', function() {
      window.location.href = 'thread.html';
    });

    // ページ読み込み時に地図を初期化
    initMap();
  </script>
</body>
</html>

